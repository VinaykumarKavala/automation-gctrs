// Cross-platform runner helper: uses sh on Linux/macOS, bat on Windows
def run(cmd) { isUnix() ? sh(cmd) : bat(cmd) }

pipeline {
  agent any

  options {
    timestamps()
    // Use the AnsiColor *wrapper* (requires AnsiColor plugin). Or delete this line if you prefer no colors.
    wrap([$class: 'AnsiColorBuildWrapper', colorMapName: 'xterm'])
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '30'))
    timeout(time: 90, unit: 'MINUTES')
  }

  parameters {
    string(name: 'RUN_ENVS',      defaultValue: '',    description: 'Subset of envs to run (dev,uat,ppd). Empty = all')
    string(name: 'RUN_TASKS',     defaultValue: '',    description: 'Subset of tasks (apiTest,uiTest,cukeApi,cukeUi,test)')
    string(name: 'RUN_BROWSERS',  defaultValue: '',    description: 'Subset of browsers (chrome,firefox,edge,"chrome,firefox"). UI-only')
    string(name: 'RUN_HEADLESS',  defaultValue: '',    description: 'Subset of headless flags (true,false). UI-only')
    string(name: 'RUN_PAR_MODE',  defaultValue: '',    description: 'Subset of par modes (none,methods,classes,tests)')
    string(name: 'RUN_THREADS',   defaultValue: '',    description: 'Subset of thread counts (2,4,6,8)')
    string(name: 'RUN_FORKS',     defaultValue: '',    description: 'Subset of forks (1,2)')
    string(name: 'CUKE_TAGS',     defaultValue: '',    description: 'Cucumber tag expression, e.g. @smoke and not @wip')
    booleanParam(name: 'CLEAN_WORKSPACE', defaultValue: true, description: 'Wipe workspace before build')
    string(name: 'AGENT_LABEL', defaultValue: '', description: 'Optional node label. Leave blank to use any agent')
  }

  environment {
    // Gradle cache inside workspace
    GRADLE_USER_HOME = "${WORKSPACE}/.gradle"
  }

  stages {

    stage('Prep') {
      steps {
        script {
          if (params.CLEAN_WORKSPACE) { deleteDir() }
        }
        checkout scm
        // No chmod on Windows; harmless on Linux
        script { if (isUnix()) sh 'chmod +x ./gradlew || true' }
        // Warm wrapper & cache
        script {
          if (isUnix()) run './gradlew --version'
          else          run 'gradlew.bat --version'
        }
      }
    }

    stage('Test Matrix') {
      matrix {
        axes {
          axis {
            name 'AX_ENV'
            values 'dev', 'uat', 'ppd'
          }
          axis {
            name 'AX_TASK'
            values 'apiTest', 'uiTest', 'cukeApi', 'cukeUi', 'test'
          }
          axis {
            name 'AX_BROWSER'
            values 'chrome', 'firefox', 'edge', 'chrome,firefox'
          }
          axis {
            name 'AX_HEADLESS'
            values 'true', 'false'
          }
          axis {
            name 'AX_PAR_MODE'
            values 'none', 'methods', 'classes', 'tests'
          }
          axis {
            name 'AX_THREADS'
            values '2', '6'
          }
          axis {
            name 'AX_FORKS'
            values '1', '2'
          }
        }

        // Filter matrix at runtime
        when {
          allOf {
            expression { acceptAxis(params.RUN_ENVS,     AX_ENV) }
            expression { acceptAxis(params.RUN_TASKS,    AX_TASK) }
            expression { acceptAxis(params.RUN_BROWSERS, AX_BROWSER) }
            expression { acceptAxis(params.RUN_HEADLESS, AX_HEADLESS) }
            expression { acceptAxis(params.RUN_PAR_MODE, AX_PAR_MODE) }
            expression { acceptAxis(params.RUN_THREADS,  AX_THREADS) }
            expression { acceptAxis(params.RUN_FORKS,    AX_FORKS) }
          }
        }

        // Correct Declarative excludes syntax
        excludes {
          exclude {
            axis { name 'AX_TASK';    value 'apiTest' }
            axis { name 'AX_BROWSER'; value 'chrome,firefox' }
          }
          exclude {
            axis { name 'AX_TASK';    value 'cukeApi' }
            axis { name 'AX_BROWSER'; value 'chrome,firefox' }
          }
        }

        // Run each cell
        stages {
          stage('Run') {
            steps {
              script {
                def envName  = AX_ENV
                def taskName = AX_TASK
                def browser  = AX_BROWSER
                def headless = AX_HEADLESS
                def parMode  = AX_PAR_MODE
                def threads  = AX_THREADS
                def forks    = AX_FORKS

                def suite   = (taskName == 'test') ? '-Dsuite=testng-mixed.xml' : ''
                def uiFlags = "-Dsel.browsers=${browser} -Dsel.headless=${headless}"
                def parFlags= "-Dpar.mode=${parMode} -Dpar.threads=${threads} -Dpar.forks=${forks}"
                def cukes   = params.CUKE_TAGS?.trim() ? "-Dcucumber.filter.tags='${params.CUKE_TAGS}'" : ""

                def cmd = isUnix()
                  ? "./gradlew ${taskName} -Denv=${envName} ${suite} ${uiFlags} ${parFlags} ${cukes} --no-daemon --stacktrace"
                  : "gradlew.bat ${taskName} -Denv=${envName} ${suite} ${uiFlags} ${parFlags} ${cukes} --no-daemon --stacktrace"

                echo "Executing: ${cmd}"
                run cmd
              }
            }
          }
        }

        post {
          always {
            junit allowEmptyResults: true, testResults: 'build/test-results/**/*.xml'
            archiveArtifacts allowEmptyArchive: true, artifacts: """
              build/reports/tests/**,
              build/reports/cuke-*/**,
              build/logs/**,
              build/reports/cucumber/**,
              build/reports/cuke-api/**,
              build/reports/cuke-ui/**
            """.stripIndent().trim()
          }
        }
      } // matrix
    } // stage: Test Matrix
  } // stages

  post {
    always {
      echo "Build finished. See archived reports and JUnit summaries above."
    }
  }
}

// ---- Helper to filter matrix rows by comma/space-separated param lists ----
@NonCPS
boolean acceptAxis(String filter, String value) {
  if (filter == null) return true
  def f = filter.trim()
  if (f.isEmpty()) return true
  def set = f.split(/[,\s]+/).collect { it.trim().toLowerCase() }.toSet()
  return set.contains(value.toLowerCase())
}
