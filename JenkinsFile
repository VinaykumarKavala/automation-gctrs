pipeline {
  agent any

  options {
    timestamps()
    ansiColor('xterm')
    disableConcurrentBuilds()
    // keep CI lean
    buildDiscarder(logRotator(numToKeepStr: '30', artifactNumToKeepStr: '30'))
    timeout(time: 90, unit: 'MINUTES')
  }

  parameters {
    // Limit the matrix at runtime (comma-separated lists). Leave blank = run all axis values.
    string(name: 'RUN_ENVS',      defaultValue: '',    description: 'Subset of envs to run (dev,uat,ppd). Empty = all')
    string(name: 'RUN_TASKS',     defaultValue: '',    description: 'Subset of tasks (apiTest,uiTest,cukeApi,cukeUi,test)')
    string(name: 'RUN_BROWSERS',  defaultValue: '',    description: 'Subset of browsers (chrome,firefox,edge,"chrome,firefox"). UI-only')
    string(name: 'RUN_HEADLESS',  defaultValue: '',    description: 'Subset of headless flags (true,false). UI-only')
    string(name: 'RUN_PAR_MODE',  defaultValue: '',    description: 'Subset of par modes (none,methods,classes,tests)')
    string(name: 'RUN_THREADS',   defaultValue: '',    description: 'Subset of thread counts (2,4,6,8)')
    string(name: 'RUN_FORKS',     defaultValue: '',    description: 'Subset of forks (1,2)')
    booleanParam(name: 'CLEAN_WORKSPACE', defaultValue: true, description: 'Wipe workspace before build')
    string(name: 'AGENT_LABEL', defaultValue: '', description: 'Optional agent label to tie this job to (blank = any)')
  }

  environment {
    // Gradle cache across builds (works on most Jenkins setups)
    GRADLE_USER_HOME = "${WORKSPACE}/.gradle"
  }

  stages {

    stage('Prep') {
      agent { label params.AGENT_LABEL?.trim() ? params.AGENT_LABEL : '' }
      steps {
        script {
          if (params.CLEAN_WORKSPACE) { deleteDir() }
        }
        checkout scm
        sh 'chmod +x ./gradlew || true'
        // Warm the wrapper & cache
        sh './gradlew --version'
      }
    }

    stage('Test Matrix') {
      matrix {
        // ---- AXES (expand or trim as needed) ----
        axes {
          axis {
            name 'AX_ENV'
            values 'dev', 'uat', 'ppd'
          }
          axis {
            name 'AX_TASK'
            // test = mixed suite (testng-mixed.xml). Others are dedicated gradle tasks we created.
            values 'apiTest', 'uiTest', 'cukeApi', 'cukeUi', 'test'
          }
          axis {
            name 'AX_BROWSER'
            // Include a combined option "chrome,firefox" to demo cross-browser DP tests
            values 'chrome', 'firefox', 'edge', 'chrome,firefox'
          }
          axis {
            name 'AX_HEADLESS'
            values 'true', 'false'
          }
          axis {
            name 'AX_PAR_MODE'
            values 'none', 'methods', 'classes', 'tests'
          }
          axis {
            name 'AX_THREADS'
            values '2', '6'
          }
          axis {
            name 'AX_FORKS'
            values '1', '2'
          }
        }

        // ---- FILTER MATRIX AT RUNTIME BASED ON PARAMETERS ----
        // Skip rows not requested by the *RUN_* filters (if filters are blank => accept all)
        when {
          allOf {
            expression { acceptAxis(params.RUN_ENVS,     AX_ENV) }
            expression { acceptAxis(params.RUN_TASKS,    AX_TASK) }
            expression { acceptAxis(params.RUN_BROWSERS, AX_BROWSER) }
            expression { acceptAxis(params.RUN_HEADLESS, AX_HEADLESS) }
            expression { acceptAxis(params.RUN_PAR_MODE, AX_PAR_MODE) }
            expression { acceptAxis(params.RUN_THREADS,  AX_THREADS) }
            expression { acceptAxis(params.RUN_FORKS,    AX_FORKS) }
          }
        }

        // ---- EXCLUDE WASTEFUL COMBOS (e.g., API tasks don’t need browsers/headless) ----
        // You can also do this with 'when' in steps; here are hard excludes:
        excludes {
          // For API-only tasks, skip extra browser combos to reduce noise
          exclude {
            axisValues 'AX_TASK=apiTest', 'AX_BROWSER=chrome,firefox'
          }
          exclude {
            axisValues 'AX_TASK=cukeApi', 'AX_BROWSER=chrome,firefox'
          }
        }

        // ---- PER-CELL EXECUTION ----
        agent { label params.AGENT_LABEL?.trim() ? params.AGENT_LABEL : '' }

        stages {
          stage('Run') {
            steps {
              script {
                // Compute flags from axes
                def envName   = AX_ENV
                def taskName  = AX_TASK           // apiTest | uiTest | cukeApi | cukeUi | test
                def browser   = AX_BROWSER        // may be "chrome,firefox"
                def headless  = AX_HEADLESS
                def parMode   = AX_PAR_MODE
                def threads   = AX_THREADS
                def forks     = AX_FORKS

                // Suite for mixed runner
                def suite = (taskName == 'test') ? '-Dsuite=testng-mixed.xml' : ''

                // UI-only flags (safe to pass for API tasks; they’ll be ignored by code)
                def uiFlags = "-Dsel.browsers=${browser} -Dsel.headless=${headless}"

                // Parallel knobs (apply to all; code ignores if mode=none)
                def parFlags = "-Dpar.mode=${parMode} -Dpar.threads=${threads} -Dpar.forks=${forks}"

                // Cucumber tags can be supplied at job-time by setting env var or extending params; default empty.
                def cukes = params.containsKey('CUKE_TAGS') ? "-Dcucumber.filter.tags='${params.CUKE_TAGS}'" : ""

                // Final command
                def cmd = "./gradlew ${taskName} -Denv=${envName} ${suite} ${uiFlags} ${parFlags} ${cukes} --no-daemon --stacktrace"
                echo "Executing: ${cmd}"
                sh cmd
              }
            }
          }
        }

        post {
          always {
            // JUnit (TestNG + Cucumber JUnit export)
            junit allowEmptyResults: true, testResults: 'build/test-results/**/*.xml'
            // Keep human-friendly HTML reports if present
            archiveArtifacts allowEmptyArchive: true, artifacts: """
              build/reports/tests/**,
              build/reports/cuke-*/**,
              build/logs/**,
              build/reports/cucumber/**,
              build/reports/cuke-api/**,
              build/reports/cuke-ui/**
            """.stripIndent().trim()
          }
        }
      } // matrix
    } // stage: Test Matrix
  } // stages

  post {
    always {
      echo "Build finished. See archived reports and JUnit summaries above."
    }
  }
}

// ---- Helper to filter matrix rows by comma/space-separated param lists ----
@NonCPS
boolean acceptAxis(String filter, String value) {
  if (filter == null) return true
  def f = filter.trim()
  if (f.isEmpty()) return true
  // Split by comma/space and normalize
  def set = f.split(/[,\s]+/).collect { it.trim().toLowerCase() }.toSet()
  return set.contains(value.toLowerCase())
}
