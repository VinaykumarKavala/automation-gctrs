pipeline {
  agent any
  options {
    timestamps()
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '20'))
  }
  parameters {
    choice(name: 'ENV', choices: ['dev', 'uat', 'ppd'], description: 'Target environment')
  }
  environment {
    GRADLE_USER_HOME = "${WORKSPACE}\\.gradle"
  }
  stages {
    stage('Prep') {
      steps {
        deleteDir()
        checkout scm
        bat 'gradlew.bat --version'
      }
    }
    stage('API Tests') {
      steps {
        bat "gradlew.bat apiTest -Denv=${params.ENV} --no-daemon --stacktrace"
      }
      post {
        always {
          junit allowEmptyResults: true, testResults: 'build/test-results/**/*.xml'
          archiveArtifacts allowEmptyArchive: true, artifacts: 'build/reports/tests/**'
        }
      }
    }
  }
  post { always { echo "Done: apiTest on ${params.ENV}" } }
}
